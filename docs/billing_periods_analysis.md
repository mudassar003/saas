# Billing Periods Analysis - MX Merchant Contract API

**Date:** 2025-10-25
**Data Source:** Production MX Merchant API
**Sample Size:** 100 contracts (All statuses: Active, Completed, Inactive)
**Merchant ID:** 1000095245

---

## üìä Discovered Billing Periods


    "records": [
        {
            "id": 1008797,
            "subscriptionId": 1007678,
            "merchantId": 1000095245,
            "name": "1112",
            "customerName": "Ryan Gerczak",
            "interval": "Weekly",
            "every": "4 Weeks",
            "on": "Thursday",
            "amount": "512",
            "type": "Recurring",
            "status": "Active",
            "startDate": "2025-11-20T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "nextBillDate": "2025-11-20T00:00:00Z"
        },
        {
            "id": 1008791,
            "subscriptionId": 1007672,
            "merchantId": 1000095245,
            "name": "1111",
            "customerName": "Ryan Gerczak",
            "interval": "Once",
            "every": "Once",
            "on": "2025-10-23",
            "amount": "750",
            "type": "Recurring",
            "status": "Completed",
            "startDate": "2025-10-23T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "lastInvoiceDate": "2025-10-23T15:37:29.303Z",
            "nextBillDate": "2025-10-23T00:00:00Z"
        },
        {
            "id": 1008608,
            "subscriptionId": 1007489,
            "merchantId": 1000095245,
            "name": "1110",
            "customerName": "Nasser Alnaemi",
            "interval": "Weekly",
            "every": "4 Weeks",
            "on": "Thursday",
            "amount": "549",
            "type": "Recurring",
            "status": "Active",
            "startDate": "2025-11-20T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "nextBillDate": "2025-11-20T00:00:00Z",
            "currencyCode": "USD"
        },
        {
            "id": 1008588,
            "subscriptionId": 1007470,
            "merchantId": 1000095245,
            "name": "1109",
            "customerName": "Nasser Alnaemi",
            "interval": "Once",
            "every": "Once",
            "on": "2025-10-23",
            "amount": "799",
            "type": "Recurring",
            "status": "Completed",
            "startDate": "2025-10-23T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "lastInvoiceDate": "2025-10-23T14:09:59.583Z",
            "nextBillDate": "2025-10-23T00:00:00Z"
        },
        {
            "id": 1008233,
            "subscriptionId": 1007116,
            "merchantId": 1000095245,
            "name": "1108",
            "customerName": "Eric Turnbaugh",
            "interval": "Once",
            "every": "Once",
            "on": "2025-10-23",
            "amount": "221",
            "type": "Recurring",
            "status": "Completed",
            "startDate": "2025-10-23T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "lastInvoiceDate": "2025-10-23T11:33:31.943Z",
            "nextBillDate": "2025-10-23T00:00:00Z"
        },
        {
            "id": 1008073,
            "subscriptionId": 1006956,
            "merchantId": 1000095245,
            "name": "1107",
            "customerName": "German Peri",
            "interval": "Once",
            "every": "Once",
            "on": "2025-10-23",
            "amount": "199",
            "type": "Recurring",
            "status": "Completed",
            "startDate": "2025-10-23T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "lastInvoiceDate": "2025-10-23T10:31:01.37Z",
            "nextBillDate": "2025-10-23T00:00:00Z"
        },
        {
            "id": 1007970,
            "subscriptionId": 1006853,
            "merchantId": 1000095245,
            "name": "1106",
            "customerName": "Matthew Dalverny",
            "interval": "Weekly",
            "every": "4 Weeks",
            "on": "Thursday",
            "amount": "252",
            "type": "Recurring",
            "status": "Active",
            "startDate": "2025-10-23T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "lastInvoiceDate": "2025-10-23T08:57:08.59Z",
            "nextBillDate": "2025-11-20T00:00:00Z"
        },
        {
            "id": 1007717,
            "subscriptionId": 1006601,
            "merchantId": 1000095245,
            "name": "1105",
            "customerName": "Ron Stevens",
            "interval": "Weekly",
            "every": "4 Weeks",
            "on": "Wednesday",
            "amount": "199",
            "type": "Recurring",
            "status": "Active",
            "startDate": "2025-11-19T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "nextBillDate": "2025-11-19T00:00:00Z"
        },
        {
            "id": 1007709,
            "subscriptionId": 1006592,
            "merchantId": 1000095245,
            "name": "1104",
            "customerName": "Ron Stevens",
            "interval": "Once",
            "every": "Once",
            "on": "2025-10-22",
            "amount": "449",
            "type": "Recurring",
            "status": "Completed",
            "startDate": "2025-10-22T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "lastInvoiceDate": "2025-10-22T17:09:32.34Z",
            "nextBillDate": "2025-10-22T00:00:00Z"
        },
        {
            "id": 1007364,
            "subscriptionId": 1006247,
            "merchantId": 1000095245,
            "name": "1103",
            "customerName": "Andrew Stout",
            "interval": "Weekly",
            "every": "4 Weeks",
            "on": "Wednesday",
            "amount": "249",
            "type": "Recurring",
            "status": "Active",
            "startDate": "2025-11-19T12:00:00Z",
            "hasDeclinedPayment": false,
            "grandTotalAmount": "309223.66",
            "nextBillDate": "2025-11-19T00:00:00Z"
        }
    ],

### ‚úÖ Confirmed Intervals from Production Data:

#### 1. **Weekly Intervals not sure if calculation below are correct** (Most Common)

| Frequency | Description | Payments/Year | Payments/Month | Example Amount | MRR Calculation |
|-----------|-------------|---------------|----------------|----------------|-----------------|
| `1 Week` | Charges every week | 52 | 4.33 | $249 | $249 √ó 4.33 = $1,078.17 |
| `4 Weeks` | Charges every 4 weeks (~monthly) | 13 | 1.08 | $249 | $249 √ó 1.08 = $269.54 |
| `10 Weeks` | Charges every 10 weeks (~2.5 months) | 5.2 | 0.43 | $162 | $162 √ó 0.43 = $70.15 |

#### 2. **One-Time** (Initial Payments)

| Frequency | Description | Status After Payment | MRR Contribution |
|-----------|-------------|---------------------|------------------|
| `Once` | Single charge (initial fee, setup fee) | `Completed` | $0 (not recurring) |

---

## ‚ùå Not Found in Production

These intervals were **NOT found** in the actual API data but they can be in future:
- ‚ùå `Monthly` - Not used by this merchant
- ‚ùå `Yearly` - Not used by this merchant
- ‚ùå `Daily` - Not used by this merchant
- ‚ùå `Bi-Weekly` - Not used (they use "4 Weeks" instead)

---

## üéØ Contract Status Values

| Status | Description | Count in MRR? | Include in Projections? |
|--------|-------------|---------------|------------------------|
| `Active` | Currently billing | ‚úÖ Yes | ‚úÖ Yes (use nextBillDate) |
| `Completed` | One-time payment finished | ‚ùå No | ‚ùå No |
| `Inactive` | Subscription paused/cancelled | ‚ùå No | ‚ùå No |
| `Cancelled` | Subscription cancelled | ‚ùå No | ‚ùå No |

---

## üí° Key Insights for Projection Logic

### 1. **Use `nextBillDate` for Accuracy**
The `nextBillDate` field is the **most reliable** indicator for projections:
```typescript
// ‚úÖ CORRECT: Use nextBillDate for projections
const projectedRevenue = contracts
  .filter(c => c.status === 'Active')
  .filter(c => {
    const nextBill = new Date(c.nextBillDate);
    return nextBill >= startDate && nextBill <= endDate;
  })
  .reduce((sum, c) => sum + parseFloat(c.amount), 0);

// ‚ùå WRONG: Don't try to calculate dates from billing_frequency
// The API already provides the exact next billing date!
```

### 2. **MRR Calculation Formula**
```typescript
function calculateMRR(contract) {
  if (contract.status !== 'Active') return 0;
  if (contract.interval === 'Once') return 0;

  if (contract.interval === 'Weekly') {
    const weeks = parseInt(contract.every.split(' ')[0]);
    const paymentsPerMonth = 4.33 / weeks;
    return contract.amount * paymentsPerMonth;
  }

  return 0;
}
```

### 3. **Status Filtering Rules**
- **MRR Calculation:** Only `Active` contracts
- **Projections:** Only `Active` contracts with `nextBillDate` in range
- **Historical Analysis:** Include all statuses

---

## üìà Real Production Examples

### Example 1: Weekly Subscriber (Most Common Pattern)
```json
{
  "customerName": "Aaron Marlow",
  "interval": "Weekly",
  "every": "4 Weeks",
  "on": "Saturday",
  "amount": "249",
  "status": "Active",
  "startDate": "2025-10-18T12:00:00Z",
  "nextBillDate": "2025-11-15T00:00:00Z"
}
```
**Analysis:**
- Charges $249 every 4 weeks
- Next payment: Nov 15, 2025
- MRR contribution: $249 √ó 1.08 = $269.54

### Example 2: High-Frequency Subscriber
```json
{
  "customerName": "Benjamin Jensen",
  "interval": "Weekly",
  "every": "1 Week",
  "on": "Wednesday",
  "amount": "535",
  "status": "Active",
  "nextBillDate": "2025-11-19T00:00:00Z"
}
```
**Analysis:**
- Charges $535 every week
- Next payment: Nov 19, 2025
- MRR contribution: $535 √ó 4.33 = $2,316.55

### Example 3: Low-Frequency Subscriber
```json
{
  "customerName": "Thomas Goolsby",
  "interval": "Weekly",
  "every": "10 Weeks",
  "on": "Wednesday",
  "amount": "162",
  "status": "Active",
  "nextBillDate": "2025-12-24T00:00:00Z"
}
```
**Analysis:**
- Charges $162 every 10 weeks
- Next payment: Dec 24, 2025
- MRR contribution: $162 √ó 0.43 = $70.15

### Example 4: One-Time Payment (Completed)
```json
{
  "customerName": "Ryan Gerczak",
  "interval": "Once",
  "every": "Once",
  "on": "2025-10-23",
  "amount": "750",
  "status": "Completed",
  "lastInvoiceDate": "2025-10-23T15:37:29.303Z"
}
```
**Analysis:**
- One-time $750 charge
- Already completed on Oct 23
- MRR contribution: $0 (not recurring)

---

## üóÑÔ∏è Database Query Examples

### Query 1: Get Projected Revenue for Next 30 Days
```sql
SELECT
  DATE(next_bill_date) as billing_date,
  COUNT(*) as payment_count,
  SUM(amount) as daily_revenue,
  ARRAY_AGG(customer_name ORDER BY customer_name) as customers
FROM contracts
WHERE status = 'Active'
  AND next_bill_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'
GROUP BY DATE(next_bill_date)
ORDER BY billing_date ASC;
```

### Query 2: Calculate Total MRR
```sql
SELECT
  SUM(CASE
    WHEN billing_interval = 'Weekly' AND billing_frequency = '1 Week'
      THEN amount * 4.33  -- Weekly: 52 payments/year √∑ 12 months
    WHEN billing_interval = 'Weekly' AND billing_frequency = '4 Weeks'
      THEN amount * 1.08  -- 4 Weeks: 13 payments/year √∑ 12 months
    WHEN billing_interval = 'Weekly' AND billing_frequency = '10 Weeks'
      THEN amount * 0.43  -- 10 Weeks: 5.2 payments/year √∑ 12 months
    ELSE 0
  END) as monthly_recurring_revenue,

  -- Breakdown by frequency
  COUNT(*) FILTER (WHERE billing_frequency = '1 Week') as weekly_count,
  COUNT(*) FILTER (WHERE billing_frequency = '4 Weeks') as four_week_count,
  COUNT(*) FILTER (WHERE billing_frequency = '10 Weeks') as ten_week_count,

  -- Total active contracts
  COUNT(*) as total_active_contracts
FROM contracts
WHERE status = 'Active'
  AND billing_interval != 'Once';
```

### Query 3: Upcoming Payments with Customer Details
```sql
SELECT
  next_bill_date,
  customer_name,
  amount,
  billing_interval || ' - ' || billing_frequency as billing_schedule,
  EXTRACT(DAY FROM (next_bill_date - CURRENT_DATE)) as days_until_payment
FROM contracts
WHERE status = 'Active'
  AND next_bill_date BETWEEN CURRENT_DATE AND CURRENT_DATE + INTERVAL '30 days'
ORDER BY next_bill_date ASC, customer_name ASC;
```

---

## ‚ö†Ô∏è Important Notes

1. **Future-Dated One-Time Contracts**: Some "Once" contracts may have `status = 'Active'` with a future `nextBillDate`. These should be included in projections.

2. **Declined Payments**: Some contracts have `hasDeclinedPayment = true`. These are still "Active" and will retry, so include them in projections.

3. **No Pattern Prediction Needed**: Don't try to calculate future billing dates manually. The API provides `nextBillDate` which is already calculated by MX Merchant's billing engine.

4. **Average 4.33 Weeks/Month**: This accounts for the fact that most months have slightly more than 4 weeks (365 days √∑ 12 months √∑ 7 days = 4.33).

---

## üìù Implementation Checklist

- [x] Analyze production data for billing periods
- [x] Document all discovered interval types
- [x] Create MRR calculation formula based on actual data
- [x] Write SQL queries for projections
- [ ] Implement MRR calculation in backend
- [ ] Implement projection queries in backend
- [ ] Create UI for date range selection
- [ ] Test with production data
- [ ] Validate calculations against actual invoices

---

## üîó Related Documentation

- [contracts.md](./contracts.md) - Main contract system documentation
- [CLAUDE.md](./CLAUDE.md) - Overall system architecture
- [mxmerchant.md](./mxmerchant.md) - MX Merchant API examples
